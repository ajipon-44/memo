# 【JS】ガチで学びたい人のための JavaScript メカニズム

## JS とは

ECMAScript ... JavaScript の仕様を決めるコアの部分

## 動作環境

### ブラウザ環境

以下の機能が使用可能

- ECMAScript

- Web APIs ... JS からブラウザの機能を利用するときに使う
  - DOM API ... 画面の更新に使われる

### Node.js 環境

以下の機能が使用可能

- ECMAScript
- Common JS ... モジュールを管理する仕組み

## JS の仕様の決め方

ES5 → ES6 ... 6 年後に変更
ES6 以降は 1 年ごとに変更 ... 仕様策定の方法が変わった

現在の仕様策定の方法 ... Living Standard
機能ごとに仕様を策定し、仕様が決まったものから順次追加していく

Stage 0 ... アイデアレベル ( Strawman )
Stage 1 ... 機能提案・検討 ( Proposal )
Stage 2 ... 暫定的に仕様決定 ( Draft )
Stage 3 ... テスト・実装 ( Candidate )
Stage 4 ... 使用決定 ( Finished )

## 実行環境の詳細

### ブラウザ環境

### User Interface

ユーザからの画面の操作を受け付ける

### Browser Engine

### Data Storage

データを蓄える領域

|                          | Cookie                                                                                                   | Session Storage                                                              | Local Storage                                               | Indexed DB                                                                             |
| ------------------------ | -------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------- | ----------------------------------------------------------- | -------------------------------------------------------------------------------------- |
| 保持できるデータサイズ   | 約 4KB                                                                                                   | 5MB~10MB                                                                     | 5MB~10MB                                                    | 数十 MB~数百 MB（ブラウザによる）                                                      |
| 保持できるデータ形式     | 文字列                                                                                                   | 文字列                                                                       | 文字列                                                      | オブジェクト                                                                           |
| データの有効期限         | セッションクッキー：ブラウザが閉じると消える<br />永続クッキー：設定による（数日〜数年）                 | ブラウザが閉じると消える<br />リロード時は保持される                         | 手動で削除するまで永続的                                    | 手動で削除するまで永続的                                                               |
| サーバへのデータ送信     |                                                                                                          |                                                                              |                                                             |                                                                                        |
| データのアクセス可能領域 | サーバサイド、クライアントサイドの両方                                                                   | クライアントサイドのみ                                                       | クライアントサイドのみ                                      | クライアントサイドのみ                                                                 |
| 用途                     | ユーザのログイン状態の維持<br />サイト訪問の頻度、利用状況の追跡、サイトのカスタマイズ（テーマ設定）など | フォームの入力途中の状態など一時的な情報の保存                               | 永続的なデータの保持（e.g. ダークモードなどサイトのテーマ） | 大容量のデータや複雑なデータの保持                                                     |
| セキュリティ上の脅威     | XSS, CSRF                                                                                                | XSS                                                                          | XSS                                                         | XSS                                                                                    |
| 補足                     |                                                                                                          | タブ間でデータの共有はしないので、同じサイトを閲覧しても別の状態を作り出せる |                                                             | Google ドキュメントはオフラインでも作業できるよう、作業中は IndexedDB に保存している。 |

### Rendering Engine

画面描画を司るエンジン

### JavaScript Engine

JavaScript の実行環境（Chrome, node.js の場合：V8）
この中に ECMAScript と Web APIs（DOM API, WebRTC, Fetch API, XHR API, Geolocation API, etc.） が存在する

### Networking

### UI Backend

## JavaScript が実行されるまで

### コード実行前

JavaScript Engine 上に、以下が用意される

- コード
- グローバルオブジェクト
  - ブラウザの場合：Window オブジェクト（WebAPIs を含んだオブジェクト）
  - JS エンジンによって生成される、コード内のどこからでもアクセスできるオブジェクト
- this

### コンテキスト

実行コンテキスト ... コードが実行されている時の状況、環境

- グローバルコンテキスト（通常時）

  - 実行中のコンテキスト（宣言した変数・関数）内の変数・関数が利用可能
  - グローバルオブジェクト
  - this

- 関数コンテキスト（関数が実行中の時に生み出されるコンテキスト、関数の実行ブロック内のこと）

  - 実行中のコンテキスト（宣言した変数・関数）内の変数・関数が利用可能

  - arguments

  - super

  - this

  - 外部変数

    - 関数の外で宣言された変数

  - ```javascript
    function b() {
      // ここが関数コンテキスト
      // この中で arguments, super, this が使えるという意味
    }
    ```

- モジュールコンテキスト

## コールスタック

コールスタック ... 実行中のコードが辿ってきたコンテキストの積み重ね

```javascript
function a() {}
function b() {
  a();
}
function c() {
  b();
}
c();
```

上の例でいうと、以下の順序でコールスタックが積み上がる。
実行中のコンテキストは 1 番上のものになる、つまり最初は a の関数コンテキストから。

1. グローバルコンテキスト
2. c
3. b
4. a

## ホイスティング

ホイスティング ... コンテキスト内で宣言した変数や関数の定義をコード実行前にメモリに配置すること（別名：変数の巻き上げ）

イメージは以下

```javascript
a();
function a() {}

console.log(b);
var b = 0;
```

↓ ホイスティング（移動させる）

```javascript
function a() {}
a();

var b;
console.log(b); // undefined
b = 0;
```

コンテキストが生成されるタイミングでホイスティングが実行される。
つまりまずファイル全体が読み込まれて、グローバルコンテキストが生成されるので、ファイルの１階層目をホイスティングする。
次に関数が実行される関数コンテキストが生成されるので関数内の変数や関数をホイスティングする。

### 関数の場合

以下のコードは問題なく動作する。
これは、変数の巻き上げによって、関数実行前に関数の定義がメモリ上に配置されているから。
**※アロー関数などの関数式の場合は変数と挙動が同じになる**

```javascript
a();

// 関数丸ごとホイスティングされる
function a() {
  console.log("a is called");
}
```

### 変数の場合

変数自体はホイスティングされ、メモリ上に領域を確保するが、値はホイスティングされない。

理由は以下の通り

1. パフォーマンス
   1. 全ての値をホイスティングすると、実行前に大量のデータをメモリに書くので、効率が悪い
2. セマンティクスの一貫性
   1. 変数の中身は実行フェーズのコードによって決まるため、実行される前に扱うことはできない
      1. 上述した関数の場合は、実行中に定義がブレることはないので関数丸ごとホイスティングされる

```javascript
console.log(a); // undefinedと表示される
var a = 0; // JS Engineによってvarのメモリスペースを確保したのち、undefinedを代入している

console.log(b); // 初期化していないエラーになる
let b = 0; // letはundefinedによる初期化を行わない

console.log(c); // 初期化していないエラーになる
const c = 0; // constはundefinedによる初期化を行わない
```
